{%- assign primary_variant = variants | first -%}
{%- assign variant_image = primary_variant.image | default: product.featured_image -%}
{%- assign product_focus_image = primary_variant.metafields.custom.product_focus_image -%}
{%- capture variant_images_json -%}
  [
  {%- for variant in variants -%}
    {
      "options": {{ variant.options | json }},
      "image": {%- if variant.image -%}"{{ variant.image | image_url: width: 900 }}"{%- else -%}""{%- endif -%},
      "focus": {%- if variant.metafields.custom.product_focus_image -%}"{{ variant.metafields.custom.product_focus_image | image_url: width: 900 }}"{%- else -%}""{%- endif -%}
    }{%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
  ]
{%- endcapture -%}

{%- assign size_values = '' -%}
{%- if size_index != blank and size_index > 0 -%}
  {%- for variant in variants -%}
    {%- case size_index -%}
      {%- when 1 -%}
        {%- assign size_value = variant.option1 -%}
      {%- when 2 -%}
        {%- assign size_value = variant.option2 -%}
      {%- when 3 -%}
        {%- assign size_value = variant.option3 -%}
    {%- endcase -%}
    {%- if size_value != blank -%}
      {%- unless size_values contains size_value -%}
        {%- assign size_values = size_values | append: size_value | append: ',' -%}
      {%- endunless -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- assign size_values = size_values | split: ',' -%}

<article
  class="custom-product-card"
  data-product-card
  data-variants='{{ variants | json | escape }}'
  data-variant-images='{{ variant_images_json | strip | escape }}'
  data-color-index="{{ color_index | default: -1 }}"
  data-size-index="{{ size_index | default: -1 }}"
  data-fixed-color="{{ color_value }}"
>
  <a class="custom-product-card__image" href="{{ product.url }}">
    {% if variant_image != blank %}
      {{ variant_image | image_url: width: 900 | image_tag: alt: product.title, loading: 'lazy', class: 'custom-product-card__image-main' }}
    {% endif %}
    {% if product_focus_image != blank %}
      {{ product_focus_image | image_url: width: 900 | image_tag: alt: product.title, loading: 'lazy', class: 'custom-product-card__image--hover' }}
    {% endif %}
  </a>

  <div class="custom-product-card__details">
    <div class="custom-product-card__info">
      <h3 class="custom-product-card__title">{{ product.title }}</h3>
      <div class="custom-product-card__price">
        {{ primary_variant.price | money }}
      </div>

      {% if size_values.size > 0 %}
        <div
          class="custom-product-card__sizes"
          data-size-list
          data-size-count="{{ size_values.size }}"
        >
          {% for value in size_values %}
            <button
              class="custom-product-card__size"
              type="button"
              data-size-value="{{ value }}"
              aria-pressed="false"
            >
              {{ value }}
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <button
      class="custom-product-card__quick-add"
      type="button"
      aria-label="Add to cart"
      data-quick-add
      data-quick-add-mode="variant"
      data-has-size="{% if size_values.size > 0 %}true{% else %}false{% endif %}"
    >
      <span class="custom-product-card__icon custom-product-card__icon--plus" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
          <path
            d="M12 5v14M5 12h14"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="square"
          />
        </svg>
      </span>
      <span class="custom-product-card__icon custom-product-card__icon--cart" aria-hidden="true">
        {{ 'icon-add-to-cart.svg' | inline_asset_content }}
      </span>
    </button>
  </div>
</article>
