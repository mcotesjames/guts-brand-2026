{%- assign product_image = product.featured_image -%}
{%- assign primary_variant = product.selected_or_first_available_variant -%}
{%- assign product_focus_image = primary_variant.metafields.custom.product_focus_image | default: product.metafields.custom.product_focus_image -%}
{%- assign price = primary_variant.price -%}
{%- assign compare_at_price = primary_variant.compare_at_price -%}
{%- assign money_price = price | money -%}

{%- capture variant_images_json -%}
  [
  {%- for variant in product.variants -%}
    {
      "options": {{ variant.options | json }},
      "image": {%- if variant.image -%}"{{ variant.image | image_url: width: 900 }}"{%- else -%}""{%- endif -%},
      "focus": {%- if variant.metafields.custom.product_focus_image -%}"{{ variant.metafields.custom.product_focus_image | image_url: width: 900 }}"{%- else -%}""{%- endif -%}
    }{%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
  ]
{%- endcapture -%}

{%- assign color_option = nil -%}
{%- assign size_option = nil -%}
{%- assign color_index = nil -%}
{%- assign size_index = nil -%}

{%- for option in product.options_with_values -%}
  {%- assign option_name = option.name | downcase -%}
  {%- if option_name contains 'color' or option_name contains 'colour' or option_name contains 'couleur' -%}
    {%- assign color_option = option -%}
    {%- assign color_index = forloop.index0 -%}
  {%- endif -%}
  {%- if option_name contains 'size' or option_name contains 'taille' -%}
    {%- assign size_option = option -%}
    {%- assign size_index = forloop.index0 -%}
  {%- endif -%}
{%- endfor -%}

<article
  class="custom-product-card"
  data-product-card
  data-variants='{{ product.variants | json | escape }}'
  data-variant-images='{{ variant_images_json | strip | escape }}'
  data-color-index="{{ color_index | default: -1 }}"
  data-size-index="{{ size_index | default: -1 }}"
>
  <a class="custom-product-card__image" href="{{ product.url }}">
    {% if product_image != blank %}
      {{ product_image | image_url: width: 900 | image_tag: alt: product.title, loading: 'lazy', class: 'custom-product-card__image-main' }}
    {% endif %}
    {{product_focus_image}}
    {% if product_focus_image != blank %}
      {{ product_focus_image | image_url: width: 900 | image_tag: alt: product.title, loading: 'lazy', class: 'custom-product-card__image--hover' }}
    {% endif %}
  </a>

  {% assign price = primary_variant.price %}
  {% assign compare_at_price = primary_variant.compare_at_price %}
  {% assign money_price = price | money %}

  <div class="custom-product-card__details">
    <div class="custom-product-card__info">
      <h3 class="custom-product-card__title">{{ product.title }}</h3>
      <div class="price">
        <div class="price__container">
          <div class="price__regular">                  
              <span class="visually-hidden visually-hidden--inline">{{ 'products.product.price.regular_price' | t }}</span>
              <span class="price-item price-item--regular">
                {{ money_price }}
              </span>
          </div>
        </div>
      </div>


      {% if color_option != nil %}
        <div class="custom-product-card__swatches" role="radiogroup" aria-label="{{ 'products.product.color' | t }}">
          {% for value in color_option.values %}
            {%- assign swatch_hex = '' -%}
            {%- assign swatch_hex_secondary = '' -%}
            {%- for variant in product.variants -%}
              {%- if swatch_hex == blank and swatch_hex_secondary == blank -%}
                {%- case color_index -%}
                  {%- when 0 -%}
                    {%- if variant.option1 == value -%}
                      {%- assign swatch_list = variant.metafields.custom.color_swatches.value | default: variant.metafields.custom.color_swatches -%}
                      {%- if swatch_list != blank -%}
                        {%- assign swatch_hex = swatch_list[0] | strip -%}
                        {%- assign swatch_hex_secondary = swatch_list[1] | strip -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- when 1 -%}
                    {%- if variant.option2 == value -%}
                      {%- assign swatch_list = variant.metafields.custom.color_swatches.value | default: variant.metafields.custom.color_swatches -%}
                      {%- if swatch_list != blank -%}
                        {%- assign swatch_hex = swatch_list[0] | strip -%}
                        {%- assign swatch_hex_secondary = swatch_list[1] | strip -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- when 2 -%}
                    {%- if variant.option3 == value -%}
                      {%- assign swatch_list = variant.metafields.custom.color_swatches.value | default: variant.metafields.custom.color_swatches -%}
                      {%- if swatch_list != blank -%}
                        {%- assign swatch_hex = swatch_list[0] | strip -%}
                        {%- assign swatch_hex_secondary = swatch_list[1] | strip -%}
                      {%- endif -%}
                    {%- endif -%}
                {%- endcase -%}
              {%- endif -%}
            {%- endfor -%}
            <button
              class="custom-product-card__swatch"
              type="button"
              data-color-value="{{ value }}"
              aria-label="{{ value }}"
              aria-pressed="{% if forloop.first %}true{% else %}false{% endif %}"
              style="{% if swatch_hex != blank and swatch_hex_secondary != blank %}background-image: linear-gradient(135deg, {{ swatch_hex }} 0 50%, {{ swatch_hex_secondary }} 50% 100%);{% else %}background-color: {% if swatch_hex != blank %}{{ swatch_hex }}{% else %}{{ value | downcase }}{% endif %};{% endif %}"
            ></button>
          {% endfor %}
        </div>
      {% endif %}

      {% if size_option != nil %}
        <div
          class="custom-product-card__sizes"
          data-size-list
          data-size-count="{{ size_option.values.size }}"
        >
          {% for value in size_option.values %}
            <button
              class="custom-product-card__size"
              type="button"
              data-size-value="{{ value }}"
              aria-pressed="false"
            >
              {{ value }}
            </button>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <button
      class="custom-product-card__quick-add"
      type="button"
      aria-label="{{ 'products.product.add_to_cart' | t }}"
      data-quick-add
      data-quick-add-mode="product"
      data-has-size="{% if size_option != nil %}true{% else %}false{% endif %}"
    >
      <span class="custom-product-card__icon custom-product-card__icon--plus" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
          <path
            d="M12 5v14M5 12h14"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="square"
          />
        </svg>
      </span>
      <span class="custom-product-card__icon custom-product-card__icon--cart" aria-hidden="true">
        {{ 'icon-add-to-cart.svg' | inline_asset_content }}
      </span>
    </button>
  </div>
</article>
